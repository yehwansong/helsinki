<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Voronoi Diagram Example</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
<script src="delaunator.min.js"></script>
<script src="three.min.js"></script>
<script src="OrbitControls.js"></script>
<script src="locations.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM=" crossorigin="anonymous"></script>
<style type="text/css">
    .tags{
        position: absolute;
        transform: translate(-50%, -50%);
    width: 10vh;
    height: 10vh;
    }
    .circle{
    width: 100%;
    height: 100%;
    border: 1px solid black;
    position: absolute;
    left: 0;
    top: 0;
}
.tags_wrapper{
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}
*{
    margin: 0;
}
html,body{
    width: 100%;
    height: 100%
}
.name{
    position: absolute;

}
</style>
</head>
<body>
    <script type="text/javascript">

    var points_pre = []
    var points = []
    var markers = [];
    var name_array = []
    var svgData
    var polygon_Array = []
    var windowWidth = window.innerWidth
    var windowHeight = window.innerHeight
    var counter = 0
    var ani_counter = 0
    let polygons_origin
    let polygons
    var height = 20
    var sphere_Array = []
    var hovered = false

        var can_w = 1000
        var can_h = 790
console.log(db.features[0].properties.img)
    // get_points()


    function map(value, start1, stop1, start2, stop2) {
        var range1 = (value - start1) / (stop1 - start1);
        var range2 = range1 * (stop2 - start2) + start2;
        return range2;
    } 
function calculateDistance(dot1, dot2) {
  const [x1, y1] = dot1;
  const [x2, y2] = dot2;
  const dx = x2 - x1;
  const dy = y2 - y1;
  return Math.sqrt(dx * dx + dy * dy);
}

assignNamesToDots(points,0);

</script>
<script>
    const scene = new THREE.Scene();

    var map
    var plane
    var pos_x = 0 
    var pos_y = 0

    const renderer = new THREE.WebGLRenderer( { alpha: true } );
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.setClearColor( 0x000000, 0 );
    const views = [
        {
            left: 0,
            bottom: 0,
            width: 1,
            height: 1,
            fov: 30,
            background: '#ffffff'
        },
        {
            left: 0.66,
            bottom: 0,
            width: 0.33,
            height: 0.33,
            fov: 5,
            background: '#ffffff'
        }
    ];
let camera
// var camera_pivot = new THREE.Group()
for ( let ii = 0; ii < views.length; ++ ii ) {
    const view = views[ ii ];
    camera = new THREE.PerspectiveCamera( view.fov, window.innerWidth / window.innerHeight, 1, 10000 );

    camera.updateProjectionMatrix();
    camera.position.set(0 , -100, -100)
    // camera_pivot.add(camera)
    // scene.add(camera_pivot)
    view.camera = camera;
}

    document.body.appendChild( renderer.domElement );


function remapFloat(v_, min0_, max0_, min1_, max1_) { return min1_ + (v_ - min0_) / (max0_ - min0_) * (max1_ - min1_); }

</script>
<script type="module">
    import * as THREE from './js/three.module.min.js';
    import  { OrbitControls }  from './js/OrbitControls.js';

function calculateDistance(point1, point2) {
  const [x1, y1] = point1;
  const [x2, y2] = point2;
  return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
}
function degreesToRadians(degrees) {
  var radians = degrees * (Math.PI / 180);
  return radians;
}
function orderPointsByDistance(array) {
    if (array.length <= 1) {
    return array;
    }

    const orderedPoints = [array[0]];
    let remainingPoints = array.slice(1);

    while (remainingPoints.length > 0) {
    const lastPoint = orderedPoints[orderedPoints.length - 1];
    let closestDistance = Infinity;
    let closestPointIndex = -1;

    for (let i = 0; i < remainingPoints.length; i++) {
      const point = remainingPoints[i];
      const distance = calculateDistance(lastPoint, point);
      if (Math.abs(distance - 100) < Math.abs(closestDistance - 100) && distance >= 200) {
        closestDistance = distance;
        closestPointIndex = i;
      }
    }

    if (closestPointIndex === -1) {
      // No point found that satisfies both conditions, break the loop
      break;
    }

    const closestPoint = remainingPoints[closestPointIndex];
    orderedPoints.push(closestPoint);
    remainingPoints.splice(closestPointIndex, 1);
    }

    return orderedPoints;
}


var objGroup
make_sphere()
function make_sphere(){
    objGroup = new THREE.Group()
    scene.add(objGroup)
    for (var i = db.features.length - 1; i >= 0; i--) {
        var group = new THREE.Group()
        objGroup.add(group)
    }
        points = Array(db.features.length)
        var min_0 = 24.84
        var max_0 = 25.12
        var min_1 = 60.14
        var max_1 = 60.25
        let texture3 = new THREE.TextureLoader().load( 'img/map.png' )
        texture3.wrapS = THREE.RepeatWrapping;
        texture3.wrapT = THREE.RepeatWrapping;
        texture3.repeat.set(0.1, 0.1);
        for (var k = points.length - 1; k >= 0; k--) {
            points[k]=Array(3)
            points[k][0] = map(db.features[k].properties.lon, min_0, max_0, -1*can_w/2, can_w/2)
            points[k][1] = map(db.features[k].properties.lat, min_1, max_1, -1*can_h/2, can_h/2)
            if(k==0){
                for (var l = points.length - 1; l >= 0; l--) {
                    const geometry = new THREE.SphereGeometry( 15, 32, 32 );
                        if(db.features[l]){
                            var img = db.features[l].properties.img
                        }else{
                            var img = ''
                        }
                    let texture = new THREE.TextureLoader().load( 'img/img_'+img+'.jpg' )
                    const m1 = new THREE.MeshBasicMaterial( { 
                                        map: texture,
                                        side: THREE.DoubleSide } );
                    const sphere = new THREE.Mesh( geometry, m1 );
                    var sphere_group = new THREE.Group()
                    sphere_group.add(sphere)
                    sphere_Array.push(sphere_group)
                    objGroup.children[l].add(sphere_group)
                    sphere.name = db.features[l].properties.img +'_'+db.features[l].properties.lon.toString().replace(/\./g, '%')+'_'+db.features[l].properties.lat.toString().replace(/\./g, '%')
                    sphere.position.z = -50

                    // const geometry_c = new THREE.BoxGeometry( 1, 1, 1000 ); 
                    const geometry_c = new THREE.CylinderGeometry( 0.5, 0.5, 1000, 6 );
            let texture4 = new THREE.TextureLoader().load( 'img/dash.png' )
            texture4.wrapS = THREE.RepeatWrapping;
            texture4.wrapT = THREE.RepeatWrapping;
            texture4.repeat.set(1, 5);
                    var material_c = new THREE.MeshBasicMaterial({ map:texture4 , transparent: true,})
                    const cube = new THREE.Mesh( geometry_c, material_c ); 
                    var cubeGroup = new THREE.Group()
                    cube.rotation.x = degToRad(90)
                    cube.position.z = 500


                    objGroup.children[l].add( cubeGroup );
                    cubeGroup.add(cube)
                    points[l][2] = 20*l
                    objGroup.children[l].position.set(points[l][0],points[l][1],points[l][2])
                }
            }
        }

                    const geometry = new THREE.PlaneGeometry( can_w*3, can_h*3 );
                    let texture2 = new THREE.TextureLoader().load( 'img/map.png' )
                    texture2.wrapS = THREE.RepeatWrapping;
                    texture2.wrapT = THREE.RepeatWrapping;
                    texture2.repeat.set(3, 3);
                    let m2 = new THREE.MeshBasicMaterial( {
                        map: texture2,
                        transparent: true,
                        side: THREE.DoubleSide
                    } );

                    map = new THREE.Mesh( geometry, m2 );
                    map.position.z = 0
                    scene.add( map );

                    let m4 = new THREE.MeshBasicMaterial( {color: 0xffffff,
                                                side: THREE.DoubleSide} ); 

                    plane = new THREE.Mesh( geometry, m4 );
                    plane.position.z = -10
                    scene.add( plane );
}
console.log(scene)
var dots = points
let currentDotIndex = 0;
let c_currentDotIndex = 0;
let currentDot = new THREE.Vector3(dots[currentDotIndex][0], dots[currentDotIndex][1], 0);
let nextDot = new THREE.Vector3(dots[currentDotIndex + 1][0], dots[currentDotIndex + 1][1], 0);
let c_currentDot = new THREE.Vector3(dots[currentDotIndex][0], dots[currentDotIndex][1], 0);
let c_nextDot = new THREE.Vector3(dots[currentDotIndex + 1][0], dots[currentDotIndex + 1][1], 0);
let t = 0.75;
let c_t = 0;
const controls = new OrbitControls( camera, renderer.domElement );
const raycaster = new THREE.Raycaster();
const pointer = new THREE.Vector2();
var intersects
var clicked = false
var click_animating = false
var click_ani_counter = 0
    const worldPosition = new THREE.Vector3();
                var x1
                var x2
                var y1
                var y2
                var z1
                var z2

// scene.fog = new THREE.Fog( 0xffffff, 3500, 6500 );
function toScreenPosition(obj, camera)
{
    var vector = new THREE.Vector3();

    var widthHalf = 0.5*renderer.context.canvas.width;
    var heightHalf = 0.5*renderer.context.canvas.height;

    obj.updateMatrixWorld();
    vector.setFromMatrixPosition(obj.matrixWorld);
    vector.project(camera);

    vector.x = ( vector.x * widthHalf ) + widthHalf;
    vector.y = - ( vector.y * heightHalf ) + heightHalf;

    return { 
        x: vector.x,
        y: vector.y
    };

};
var target = new THREE.Vector3(); // create once an reuse it

  $(document).ready(function(){
    $('canvas').click(function(){
        console.log('sd;lkfjds')
        if(intersects.length>0 &&clicked== false){
            clicked = true
            click_ani_counter = 0
        }

    })
  // Event listeners for arrow key presses
  document.addEventListener('keydown', onKeyDown);
  document.addEventListener('keyup', onKeyUp);

  })







var moveLeft = false;
var moveRight = false;
var moveUp = false;
var moveDown = false;

function onKeyDown(event) {
  switch (event.keyCode) {
    case 37: // Left arrow key
      moveLeft = true;
      break;
    case 39: // Right arrow key
      moveRight = true;
      break;
    case 38: // Up arrow key
      moveUp = true;
      break;
    case 40: // Down arrow key
      moveDown = true;
      break;
  }
}

function onKeyUp(event) {
  switch (event.keyCode) {
    case 37: // Left arrow key
      moveLeft = false;
      break;
    case 39: // Right arrow key
      moveRight = false;
      break;
    case 38: // Up arrow key
      moveUp = false;
      break;
    case 40: // Down arrow key
      moveDown = false;
      break;
  }
}

window.addEventListener( 'pointermove', onPointerMove );
function onPointerMove( event ) {
    pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
    pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
}

function animate() {
if(clicked){

}else{

}

for (var i = points.length - 1; i >= 0; i--) {
            if(((points[i][2]-1*ani_counter) - (Math.abs((ani_counter/3)%2000-1000)-1500))/1000<0){
                objGroup.children[i].children[1].scale.set(1,1,Math.abs(((points[i][2]-1*ani_counter) - (Math.abs((ani_counter/3)%2000-1000)-1500))/1000))
            }else{
                objGroup.children[i].children[1].scale.set(0,0,0)
            }
    // if(points[i][2]-1*ani_counter<-5000){
    //     points[i][2] = points[i][2]+objGroup.children.length*20
    //     objGroup.children[i].position.set(points[i][0],points[i][1],points[i][2])
    // }
}
if(ani_counter<8000){
    ani_counter = ani_counter+30
    for (var i = points.length - 1; i >= 0; i--) {
        objGroup.children[i].position.z = (points[i][2]-((points[i][2]-5100)/8000)*ani_counter)
    }
}
if(ani_counter > 7960){
    for (var i = points.length - 1; i >= 0; i--) {
        console.log(objGroup.children[i].position.z)
    }
}
map.position.z =-1*Math.abs(ani_counter/3)+1000
plane.position.z =Math.abs((ani_counter/3)%2000-1000)-1500+5000


for (let ii = 0; ii < views.length; ii++) {
    const view = views[ii];
    const camera = view.camera;


    const left = Math.floor(windowWidth * view.left);
    const bottom = Math.floor(windowHeight * view.bottom);
    const width = Math.floor(windowWidth * view.width);
    const height = Math.floor(windowHeight * view.height);
    if (moveLeft) {
        pos_y = pos_y+ 1;
    }
    if (moveRight) {
        pos_y = pos_y- 1;
    }
    if (moveUp) {
        pos_x = pos_x- 1;
    }
    if (moveDown) {
        pos_x = pos_x+ 1;
    }
    camera.rotation.z = degToRad(ani_counter/100)
    if(!clicked){
        objGroup.position.z = -1*ani_counter+1000
    }
    objGroup.position.x  = pos_x
    objGroup.position.y  = pos_y
    map.position.x  = pos_x
    map.position.y  = pos_y
    var value = Math.floor(ani_counter/20)-100
    
    if (ii == 0) {
        raycaster.setFromCamera( pointer, camera );
        intersects = raycaster.intersectObjects( sphere_Array );
        for (var i = sphere_Array.length - 1; i >= 0; i--) {
            hovered = false
            sphere_Array[i].children[0].material.color.set( 0xffffff );
        }
        for ( let i = 0; i < intersects.length; i ++ ) {
            hovered = true
            intersects[ i ].object.material.color.set( 0x000000 );
        }
        camera.up.set(0, 1, 1);
        camera.position.set(0,0,-3000)
        camera.lookAt(0, 0, 0);
        if(clicked){
            click_ani_counter++
            if(x1 === undefined){
            x2 = camera.getWorldPosition(worldPosition).x
            y2 = camera.getWorldPosition(worldPosition).y
            z2 = camera.getWorldPosition(worldPosition).z
            x1 = intersects[0].object.getWorldPosition(worldPosition).x
            y1 = intersects[0].object.getWorldPosition(worldPosition).y
            z1 = intersects[0].object.getWorldPosition(worldPosition).z}
            if(click_ani_counter<100){

                const x = easeInOutQuad(click_ani_counter/100, x2, x1 - x2, 1);
                const y = easeInOutQuad(click_ani_counter/100, y2, y1 - y2, 1);
                const z = easeInOutQuad(click_ani_counter/100, z2, z1 - z2, 1);
                camera.position.set(x,y,z)
                console.log(z)
            }else{
                window.location.replace("pano.html#"+intersects[0].object.name);
            }
        }else{

        }
        if(objGroup.children[(value-10)%(objGroup.children.length-5)]){
            $('.tags_0').css({'left':toScreenPosition(objGroup.children[(value-10)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_0').css({'top' :toScreenPosition(objGroup.children[(value-10)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_0').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-9)%(objGroup.children.length-5)]){
            $('.tags_1').css({'left':toScreenPosition(objGroup.children[(value-9)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_1').css({'top' :toScreenPosition(objGroup.children[(value-9)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_1').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-8)%(objGroup.children.length-5)]){
            $('.tags_2').css({'left':toScreenPosition(objGroup.children[(value-8)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_2').css({'top' :toScreenPosition(objGroup.children[(value-8)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_2').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-7)%(objGroup.children.length-5)]){
            $('.tags_3').css({'left':toScreenPosition(objGroup.children[(value-7)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_3').css({'top' :toScreenPosition(objGroup.children[(value-7)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_3').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-6)%(objGroup.children.length-5)]){
            $('.tags_4').css({'left':toScreenPosition(objGroup.children[(value-6)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_4').css({'top' :toScreenPosition(objGroup.children[(value-6)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_4').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-5)%(objGroup.children.length-5)]){
            $('.tags_5').css({'left':toScreenPosition(objGroup.children[(value-5)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_5').css({'top' :toScreenPosition(objGroup.children[(value-5)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_5').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-4)%(objGroup.children.length-5)]){
            $('.tags_6').css({'left':toScreenPosition(objGroup.children[(value-4)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_6').css({'top' :toScreenPosition(objGroup.children[(value-4)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_6').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-3)%(objGroup.children.length-5)]){
            $('.tags_7').css({'left':toScreenPosition(objGroup.children[(value-3)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_7').css({'top' :toScreenPosition(objGroup.children[(value-3)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_7').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
        if(objGroup.children[(value-2)%(objGroup.children.length-5)]){
            $('.tags_8').css({'left':toScreenPosition(objGroup.children[(value-2)%(objGroup.children.length-5)].children[0], camera).x+'px'})
            $('.tags_8').css({'top' :toScreenPosition(objGroup.children[(value-2)%(objGroup.children.length-5)].children[0], camera).y+'px'})
            $('.tags_8').find('.name').html(db.features[(value-2)%(objGroup.children.length-5)].properties.img)
        }
    } else {
        camera.up.set(0,1, 1);
        camera.position.set(0,0,(-7500+Math.abs((ani_counter/3)%2000-1000)-1500))

        camera.zoom = 1;   
        camera.lookAt(0, 0, 0);
    }

    renderer.setViewport(left, bottom, width, height);
    renderer.setScissor(left, bottom, width, height);
    renderer.setScissorTest(true);
    renderer.setClearColor(view.background);

    camera.aspect = width / height;
    camera.updateProjectionMatrix();

    renderer.render(scene, camera);
    }

  requestAnimationFrame(animate);
}

function ease(t) {
  return t<.5 ? 2*t*t : -1+(4-2*t)*t;
}
function easeInOutQuad(t, b, c, d) {
  t /= d / 2;
  if (t < 1) return c / 2 * t * t + b;
  t--;
  return -c / 2 * (t * (t - 2) - 1) + b;
}
    animate();
function degToRad(degrees) {
  return degrees * Math.PI / 180;
}
</script>
<div class="tags_wrapper">
<div class="tags tags_0"><div class="name">tags_0</div><div class="circle"></div></div>
<div class="tags tags_1"><div class="name">tags_1</div><div class="circle"></div></div>
<div class="tags tags_2"><div class="name">tags_2</div><div class="circle"></div></div>
<div class="tags tags_3"><div class="name">tags_3</div><div class="circle"></div></div>
<div class="tags tags_4"><div class="name">tags_4</div><div class="circle"></div></div>
<div class="tags tags_5"><div class="name">tags_5</div><div class="circle"></div></div>
<div class="tags tags_6"><div class="name">tags_6</div><div class="circle"></div></div>
<div class="tags tags_7"><div class="name">tags_7</div><div class="circle"></div></div>
<div class="tags tags_8"><div class="name">tags_8</div><div class="circle"></div></div>
</div>

</body>
</html>
